<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agente FinanÃ§as - Dashboard</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#121212">

    <style>
        :root { 
            --green: #2ecc71; --red: #e74c3c; --blue: #3498db;
            --bg: #121212; --card-bg: #1e1e1e; --text-main: #e0e0e0; 
            --border: #333333; --pink: #ff4081;
        }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text-main); margin: 0; padding: 15px; display: flex; flex-direction: column; align-items: center; }
        .card { background: var(--card-bg); padding: 20px; border-radius: 20px; width: 100%; max-width: 500px; border: 1px solid var(--border); box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        h2 { color: var(--pink); text-align: center; font-size: 16px; text-transform: uppercase; letter-spacing: 2px; }
        
        .dash-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin: 20px 0; }
        .metric { background: #181818; padding: 15px; border-radius: 12px; text-align: center; border: 1px solid var(--border); }
        .metric label { display: block; font-size: 10px; color: #888; text-transform: uppercase; }
        .metric span { font-size: 18px; font-weight: bold; }
        .metric.up { color: var(--green); }
        .metric.down { color: var(--red); }

        /* Estilo do GrÃ¡fico */
        .chart-container { position: relative; margin: 20px auto; height: 200px; width: 200px; }

        .transacao-list { display: flex; flex-direction: column; gap: 8px; max-height: 300px; overflow-y: auto; margin-top: 20px;}
        .item-transacao { background: #252525; padding: 12px; border-radius: 10px; display: flex; justify-content: space-between; align-items: center; border-left: 4px solid var(--blue); }
        .item-transacao.entrada { border-left-color: var(--green); }
        .item-transacao.saida { border-left-color: var(--red); }
        .info { display: flex; flex-direction: column; }
        .info .nome { font-weight: bold; font-size: 14px; }
        .info .detalhes { font-size: 10px; color: #aaa; }
        .valor { font-weight: bold; font-size: 14px; }
        
        .btn-update { background: var(--pink); color: white; border: none; padding: 15px; border-radius: 12px; width: 100%; font-weight: bold; cursor: pointer; margin-top: 20px; }
        #status { font-size: 9px; text-align: center; margin-top: 10px; color: #444; }
    </style>
</head>
<body onload="init()">

<div class="card">
    <h2>AGENT FINANÃ‡AS AI</h2>
    
    <div class="dash-grid">
        <div class="metric up"><label>Receitas</label><span id="total-entradas">R$ 0,00</span></div>
        <div class="metric down"><label>Despesas</label><span id="total-saidas">R$ 0,00</span></div>
    </div>

    <div class="chart-container">
        <canvas id="meuGrafico"></canvas>
    </div>

    <div id="lista" class="transacao-list"></div>
    
    <button class="btn-update" onclick="carregarDados()">ðŸ”„ ATUALIZAR AGORA</button>
    <div id="status">Sincronizado</div>
</div>

<script>
    const URL_API = "https://script.google.com/macros/s/AKfycbwbx4Utft2D_59jbBZP6jbqKEIHrxeKnK_MarrksV1dzZ7_CK74Z9ITmb0xN0bRdxeTVA/exec";
    let myChart = null;

    function init() { carregarDados(); registrarSW(); }

    function registrarSW() {
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js').catch(err => console.log(err));
        }
    }

    async function carregarDados() {
        document.getElementById('status').innerText = "Conectando...";
        try {
            const response = await fetch(URL_API + "?t=" + new Date().getTime());
            const dados = await response.json();
            renderizar(dados);
            document.getElementById('status').innerText = "Sincronizado: " + new Date().toLocaleTimeString();
        } catch (e) { 
            document.getElementById('status').innerText = "Erro ao carregar."; 
        }
    }

    function renderizar(dados) {
        const listaDiv = document.getElementById('lista');
        let html = ""; let tEntrada = 0; let tSaida = 0;

        dados.slice().reverse().forEach((item, index) => {
            const v = parseFloat(item.Valor || 0);
            const tipo = (item.Tipo || "").toString().toLowerCase().trim();
            const ehReceita = tipo === 'receita' || tipo === 'entrada';

            if(ehReceita) tEntrada += v; else tSaida += v;

            // Mantendo nosso Hacker de HorÃ¡rio (-3h)
            let dataBR = "--/--";
            if (item.Data) {
                let d = new Date(item.Data.includes('/') ? item.Data.split(' ')[0].split('/').reverse().join('-') + 'T' + (item.Data.split(' ')[1] || '00:00:00') : item.Data);
                if(!isNaN(d.getTime())) {
                    const dataAjustada = new Date(d.getTime() - (3 * 3600000));
                    dataBR = dataAjustada.toLocaleDateString('pt-BR') + " " + dataAjustada.toLocaleTimeString('pt-BR', {hour:'2-digit', minute:'2-digit'});
                }
            }

            if(index < 25) { // Aumentei para 25 para vocÃª ver mais itens
                html += `
                    <div class="item-transacao ${ehReceita ? 'entrada' : 'saida'}">
                        <div class="info">
                            <span class="nome">${item.Item || 'Sem Nome'}</span>
                            <span class="detalhes">${item.Categoria || 'Geral'} â€¢ ${dataBR}</span>
                            
                            ${item.Comentario_da_IA ? 
                                `<div style="font-size: 10px; color: #3498db; margin-top: 5px; background: #1a2a3a; padding: 5px; border-radius: 4px;">
                                    ðŸ¤– ${item.Comentario_da_IA}
                                 </div>` 
                                : ''
                            }
                        </div>
                        <div class="valor">${ehReceita ? '+' : '-'} R$ ${v.toFixed(2)}</div>
                    </div>`;
            }
        });

        listaDiv.innerHTML = html;
        document.getElementById('total-entradas').innerText = `R$ ${tEntrada.toFixed(2)}`;
        document.getElementById('total-saidas').innerText = `R$ ${tSaida.toFixed(2)}`;

        atualizarGrafico(tEntrada, tSaida);
    }

    function atualizarGrafico(entradas, saidas) {
        const ctx = document.getElementById('meuGrafico').getContext('2d');
        
        if (myChart) { myChart.destroy(); }

        myChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Receitas', 'Despesas'],
                datasets: [{
                    data: [entradas, saidas],
                    backgroundColor: ['#2ecc71', '#e74c3c'],
                    borderColor: '#1e1e1e',
                    borderWidth: 2
                }]
            },
            options: {
                plugins: { legend: { display: false } },
                cutout: '70%'
            }
        });
    }
</script>
</body>
</html>
